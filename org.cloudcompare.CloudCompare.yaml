app-id: org.cloudcompare.CloudCompare
runtime: org.kde.Platform
runtime-version: 5.15-24.08
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: 5.15-24.08
command: CloudCompare
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --share=network
  - --env=PYTHONPATH=/app/lib/cloudcompare
  - --filesystem=home
  - --filesystem=/tmp
  - --filesystem=xdg-run/gvfs # GVfs
  - --filesystem=/media # automount via udisks

cleanup:
  - /bin/applygeo
  - /bin/cgal_*
  - /bin/CreateDOMDocument
  - /bin/DOM*
  - /bin/EnumVal
  - /bin/flann*
  - /bin/gdal*
  - /bin/geotifcp
  - /bin/gnmanalyse
  - /bin/gnmmanage
  - /bin/listgeo
  - /bin/makegeo
  - /bin/MemParse
  - /bin/nearblack
  - /bin/ogr*
  - /bin/opencv_version
  - /bin/PParse
  - /bin/projsync
  - /bin/PSVIWriter
  - /bin/Redirect
  - /bin/SAX*
  - /bin/SCMPrint
  - /bin/SEnumVal
  - /bin/StdInParse
  - /bin/testepsg
  - /bin/vsyasm
  - /bin/XInclude
  - /bin/yasm

  # Python artifacts
  - /bin/3DFin
  - /bin/f2py*
  - /bin/laspy
  - /bin/numpy-config
  - /bin/setuptools-scm

  - /bin/pybind11-config
  - /bin/setup_vars_opencv4.sh
  - /bin/vba_extract.py

  - /lib/cmake
  - /lib/gdalplugins
  - /lib/pkgconfig
  - '*.a'
  - '*.la'

  - /share/cmake
  - /share/doc
  - /share/eigen3
  - /share/flann
  - /share/gdal
  - /share/info
  - /share/man
  - /share/opencv4
  - /share/pcl-*
  - /share/pkgconfig
  - /share/proj

  - /include

  - /doc

cleanup-commands:
  - /app/cleanup-BaseApp.sh

build-options:
  env:
    BASEAPP_REMOVE_WEBENGINE: '1' # cleanup-BaseApp.sh will remove PyQT WebEngine artifacts

modules:
  - name: boost
    sources:
      - type: archive
        url: https://archives.boost.io/release/1.90.0/source/boost_1_90_0.tar.bz2
        sha256: 49551aff3b22cbc5c5a9ed3dbc92f0e23ea50a0f7325b0d198b705e8ee3fc305
        x-checker-data:
          type: anitya
          project-id: 6845
          stable-only: true
          url-template: https://archives.boost.io/release/$version/source/boost_${major}_${minor}_${patch}.tar.bz2
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --with-toolset=gcc --prefix=/app --with-libraries=thread,system,date_time,filesystem,iostreams,atomic,chrono,graph,multiprecision
      - ./b2 toolset=gcc cxxflags=-fPIC cflags=-fPIC -a link=static install -j ${FLATPAK_BUILDER_N_JOBS}

  - name: CGAL
    sources:
      - type: archive
        url: https://github.com/CGAL/cgal/releases/download/v6.1.1/CGAL-6.1.1-library.tar.xz
        sha256: 37e9fffe48a83209b070e1914c6aa0a7bae8076749712ab78b53245e176e0e0e
        x-checker-data:
          type: anitya
          project-id: 273
          stable-only: true
          url-template: https://github.com/CGAL/cgal/releases/download/v$version/CGAL-$version-library.tar.xz
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_POSITION_INDEPENDENT_CODE=ON

  - name: PROJ
    sources:
      - type: archive
        url: https://github.com/OSGeo/PROJ/releases/download/9.7.1/proj-9.7.1.tar.gz
        sha256: 6c097dc803c561929cdfcc46e4bf9945ea977611fb31493ad14e88edaeae260f
        x-checker-data:
          type: anitya
          project-id: 9463
          stable-only: true
          url-template: https://github.com/OSGeo/PROJ/releases/download/$version/proj-$version.tar.gz
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=OFF
      - -DCMAKE_POSITION_INDEPENDENT_CODE=ON
      - -DBUILD_TESTING=OFF
      - -DBUILD_CCT=OFF
      - -DBUILD_CS2CS=OFF
      - -DBUILD_GEOD=OFF
      - -DBUILD_GIE=OFF
      - -DBUILD_PROJ=OFF
      - -DBUILD_PROJINFO=OFF

  - name: XercesC
    sources:
      - type: archive
        url: https://dlcdn.apache.org//xerces/c/3/sources/xerces-c-3.3.0.tar.gz
        sha256: 9555f1d06f82987fbb4658862705515740414fd34b4db6ad2ed76a2dc08d3bde
        x-checker-data:
          type: anitya
          project-id: 5182
          url-template: https://dlcdn.apache.org//xerces/c/3/sources/xerces-c-$version.tar.gz
      - type: patch
        path: patches/xerces.patch
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DCMAKE_POSITION_INDEPENDENT_CODE=ON

  - name: GeoTIFF
    sources:
      - type: archive
        url: https://github.com/OSGeo/libgeotiff/releases/download/1.7.4/libgeotiff-1.7.4.tar.gz
        sha256: c598d04fdf2ba25c4352844dafa81dde3f7fd968daa7ad131228cd91e9d3dc47
        x-checker-data:
          type: anitya
          project-id: 21361
          stable-only: true
          url-template: https://github.com/OSGeo/libgeotiff/releases/download/$version/libgeotiff-$version.tar.gz
    builddir: true
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DCMAKE_POSITION_INDEPENDENT_CODE=ON
      - -DWITH_UTILITIES=OFF

  - name: GDAL
    sources:
      - type: archive
        url: https://github.com/OSGeo/gdal/releases/download/v3.12.1/gdal-3.12.1.tar.gz
        sha256: 266cbadf8534d1de831db8834374afd95603e0a6af4f53d0547ae0d46bd3d2d1
        x-checker-data:
          type: anitya
          project-id: 881
          stable-only: true
          url-template: https://github.com/OSGeo/gdal/releases/download/v$version/gdal-$version.tar.gz
    builddir: true
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DCMAKE_POSITION_INDEPENDENT_CODE=ON
      - -DBUILD_PYTHON_BINDINGS=OFF
      - -DBUILD_APPS=OFF
      - -DGDAL_BUILD_OPTIONAL_DRIVERS=OFF
      - -DOGR_BUILD_OPTIONAL_DRIVERS=OFF

  - name: TBB
    sources:
      - type: archive
        url: https://github.com/oneapi-src/oneTBB/archive/refs/tags/v2022.3.0.tar.gz
        sha256: 01598a46c1162c27253a0de0236f520fd8ee8166e9ebb84a4243574f88e6e50a
        x-checker-data:
          type: anitya
          project-id: 8217
          stable-only: true
          url-template: https://github.com/oneapi-src/oneTBB/archive/refs/tags/v$version.tar.gz
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DTBB_TEST=OFF

  - name: Eigen
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/5.0.1/eigen-5.0.1.tar.bz2
        sha256: e4de6b08f33fd8b8985d2f204381408c660bffa6170ac65b68ae1bd3cd575c0a
        x-checker-data:
          type: anitya
          project-id: 666
          stable-only: true
          url-template: https://gitlab.com/libeigen/eigen/-/archive/$version/eigen-$version.tar.bz2
    builddir: true
    buildsystem: cmake-ninja

  - name: FLANN
    sources:
      - type: archive
        url: https://github.com/flann-lib/flann/archive/refs/tags/1.9.2.tar.gz
        sha256: e26829bb0017f317d9cc45ab83ddcb8b16d75ada1ae07157006c1e7d601c8824
        x-checker-data:
          type: anitya
          project-id: 21432
          stable-only: true
          url-template: https://github.com/flann-lib/flann/archive/refs/tags/$version.tar.gz
    builddir: true
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=OFF # builds libflann_cpp.so and libflann_cpp_s.a anyway
      - -DBUILD_C_BINDINGS=OFF
      - -DBUILD_EXAMPLES=OFF
      - -DBUILD_TESTS=OFF
      - -DBUILD_DOC=OFF

  - name: Dlib
    sources:
      - type: archive
        url: http://dlib.net/files/dlib-20.0.tar.bz2
        sha256: 5fce3181d9f0bf4e4bc867f13e5a0172f19d47918e6a4d335de478daf269fb63
        x-checker-data:
          type: anitya
          project-id: 18600
          stable-only: true
          url-template: http://dlib.net/files/dlib-${major}.${minor}.tar.bz2
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=OFF
      - -DDLIB_NO_GUI_SUPPORT=ON

  - name: PCL
    sources:
      - type: archive
        url: https://github.com/PointCloudLibrary/pcl/releases/download/pcl-1.15.1/source.tar.gz
        sha256: f187b2646422ae6fb6daf7eec2d62c538ae7fe626397ed649c0e9b5a5b862b5a
        x-checker-data:
          type: anitya
          project-id: 141386
          stable-only: true
          url-template: https://github.com/PointCloudLibrary/pcl/releases/download/pcl-$version/source.tar.gz
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=OFF
      - -DPCL_SHARED_LIBS=OFF
      - -DCMAKE_POSITION_INDEPENDENT_CODE=ON
      - -DWITH_LIBUSB=OFF
      - -DWITH_OPENGL=OFF
      - -DWITH_QT=OFF
      - -DWITH_VTK=OFF
      - -DWITH_PCAP=OFF
      - -DPCL_ONLY_CORE_POINT_TYPES=ON
      - -DBUILD_2d=ON
      - -DBUILD_CUDA=OFF
      - -DBUILD_GPU=OFF
      - -DBUILD_apps=OFF
      - -DBUILD_common=ON
      - -DBUILD_examples=OFF
      - -DBUILD_features=ON
      - -DBUILD_filters=ON
      - -DBUILD_geometry=OFF
      - -DBUILD_global_tests=OFF
      - -DBUILD_io=ON
      - -DBUILD_kdtree=ON
      - -DBUILD_keypoints=ON
      - -DBUILD_ml=OFF
      - -DBUILD_octree=ON
      - -DBUILD_outofcore=OFF
      - -DBUILD_people=OFF
      - -DBUILD_recognition=OFF
      - -DBUILD_registration=OFF
      - -DBUILD_sample_consensus=ON
      - -DBUILD_search=ON
      - -DBUILD_segmentation=OFF
      - -DBUILD_simulation=OFF
      - -DBUILD_stereo=OFF
      - -DBUILD_surface=ON
      - -DBUILD_tools=OFF
      - -DBUILD_tracking=OFF
      - -DBUILD_visualization=OFF

  - name: LASzip
    sources:
      - type: archive
        url: https://github.com/LASzip/LASzip/releases/download/3.4.4/laszip-src-3.4.4.tar.gz
        sha256: 41f826848ff106f471b134224f58075ac8e36a62b6ba0ad75be8a8c191bdba4b
        x-checker-data:
          type: anitya
          project-id: 241499
          stable-only: true
          url-template: https://github.com/LASzip/LASzip/releases/download/$version/laszip-src-$version.tar.gz
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release

  - name: OpenCV
    sources:
      - type: archive
        url: https://github.com/opencv/opencv/archive/4.13.0.tar.gz
        sha256: 1d40ca017ea51c533cf9fd5cbde5b5fe7ae248291ddf2af99d4c17cf8e13017d
        x-checker-data:
          type: anitya
          project-id: 6615
          stable-only: true
          url-template: https://github.com/opencv/opencv/archive/$version.tar.gz
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_LIST=ml,core,imgproc,imgcodecs,highgui
      - -DWITH_OPENCL=ON
      - -DWITH_QT=ON
      - -DWITH_TBB=ON
      - -DWITH_PROTOBUF=OFF
      - -DBUILD_opencv_python2=OFF
      - -DBUILD_opencv_python3=OFF

  - name: glu
    buildsystem: meson
    sources:
      - type: archive
        url: https://mesa.freedesktop.org/archive/glu/glu-9.0.3.tar.xz
        sha256: bd43fe12f374b1192eb15fe20e45ff456b9bc26ab57f0eee919f96ca0f8a330f
        x-checker-data:
          type: anitya
          project-id: 13518
          stable-only: true
          url-template: https://mesa.freedesktop.org/archive/glu/glu-$version.tar.xz
    cleanup:
      - /include
      - /lib/*.a
      - /lib/*.la
      - /lib/pkgconfig

  # Python3 modules needed by CloudCompare-PythonRuntime, 3DFin, etc
  - python3-deps.yaml

  - name: CloudCompare
    sources:
      - type: git
        url: https://github.com/CloudCompare/CloudCompare.git
        commit: 8660dcc86da2d86066649dc3e8438a813d310dc7 # Sept 21 2025
      - type: patch
        path: patches/cc-treeiso.patch
      - type: git
        url: https://github.com/tmontaigu/CloudCompare-PythonRuntime.git
        commit: a07c38407455bb0a7bd924bc65c3c26e6399bc15 # Sept 27 2025
        dest: plugins/private/CloudCompare-PythonRuntime
      - type: patch
        path: patches/CloudCompare-PythonRuntime.patch
    builddir: true
    build-options:
      cxxflags: -I/usr/include/python3.11 -Wno-deprecated-declarations # reduce QT deprecations noise, should be fixed upstream
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=OFF
      - -DCCCORELIB_USE_CGAL=ON # implicit use for CGAL warning
      - -DCCCORELIB_USE_TBB=ON
      - -DOPTION_USE_GDAL=ON
      - -DOPTION_USE_DXF_LIB=ON
      - -DOPTION_USE_SHAPE_LIB=ON
      - -DEIGEN_ROOT_DIR=/app/include/eigen3
      - -DPLUGIN_STANDARD_3DMASC=ON
      - -DPLUGIN_GL_QEDL=ON
      - -DPLUGIN_GL_QSSAO=ON
      - -DPLUGIN_IO_QADDITIONAL=ON
      - -DPLUGIN_IO_QCORE=ON
      - -DPLUGIN_IO_QCSV_MATRIX=ON
      - -DPLUGIN_IO_QE57=ON
      - -DPLUGIN_IO_QPHOTOSCAN=ON
      - -DPLUGIN_IO_QLAS=ON
      - -DPLUGIN_STANDARD_QANIMATION=ON
      - -DQANIMATION_WITH_FFMPEG_SUPPORT=ON
      - -DPLUGIN_STANDARD_QBROOM=ON
      - -DPLUGIN_STANDARD_QCANUPO=ON
      - -DPLUGIN_STANDARD_QCLOUDLAYERS=ON
      - -DPLUGIN_STANDARD_QCOMPASS=ON
      - -DPLUGIN_STANDARD_QCOLORIMETRIC_SEGMENTER=ON
      - -DPLUGIN_STANDARD_QCSF=ON
      - -DPLUGIN_STANDARD_QFACETS=ON
      - -DPLUGIN_STANDARD_QHOUGH_NORMALS=ON
      - -DPLUGIN_STANDARD_QHPR=ON
      - -DPLUGIN_STANDARD_QM3C2=ON
      - -DPLUGIN_STANDARD_MASONRY_QAUTO_SEG=ON
      - -DPLUGIN_STANDARD_MASONRY_QMANUAL_SEG=ON
      - -DPLUGIN_STANDARD_QMPLANE=ON
      - -DPLUGIN_STANDARD_QPCL=ON
      - -DPLUGIN_STANDARD_QPCV=ON
      - -DPLUGIN_STANDARD_QPOISSON_RECON=ON
      - -DPLUGIN_STANDARD_QSRA=ON
      - -DPLUGIN_STANDARD_QTREEISO=ON
      - -DPLUGIN_PYTHON=ON
      - -DPLUGIN_PYTHON_USE_EMBEDDED_MODULES=ON

    post-install:
      - install -d /app/share/icons/hicolor/256x256/apps
      - cp ${FLATPAK_BUILDER_BUILDDIR}/qCC/images/icon/cc_icon_256.png /app/share/icons/hicolor/256x256/apps/org.cloudcompare.CloudCompare.png
      - chmod 644 /app/share/icons/hicolor/256x256/apps/org.cloudcompare.CloudCompare.png
      - cp ${FLATPAK_BUILDER_BUILDDIR}/qCC/images/icon/cc_viewer_icon_256.png /app/share/icons/hicolor/256x256/apps/org.cloudcompare.CloudCompare.Viewer.png
      - chmod 644 /app/share/icons/hicolor/256x256/apps/org.cloudcompare.CloudCompare.Viewer.png

  - name: launchers
    buildsystem: simple
    sources:
      - type: file
        path: org.cloudcompare.CloudCompare.desktop
      - type: file
        path: org.cloudcompare.CloudCompare.Viewer.desktop
      - type: file
        path: org.cloudcompare.CloudCompare.appdata.xml
    build-commands:
      - install -d /app/share/applications
      - install -m644 org.cloudcompare.CloudCompare.desktop /app/share/applications/org.cloudcompare.CloudCompare.desktop
      - install -m644 org.cloudcompare.CloudCompare.Viewer.desktop /app/share/applications/org.cloudcompare.CloudCompare.Viewer.desktop
      - install -d /app/share/metainfo
      - install -m644 org.cloudcompare.CloudCompare.appdata.xml /app/share/metainfo/org.cloudcompare.CloudCompare.appdata.xml
